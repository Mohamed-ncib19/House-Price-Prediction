<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyline Console - Model Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gradient-text {
            background: linear-gradient(135deg, #60a5fa 0%, #c084fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-healthy {
            color: #4ade80;
            background: rgba(74, 222, 128, 0.1);
        }

        .status-offline {
            color: #f87171;
            background: rgba(248, 113, 113, 0.1);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom scrollbar for data table */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>

<body class="bg-[#0b0f1a] text-white min-h-screen">
    <div class="max-w-7xl mx-auto px-6 py-12">
        <!-- Header -->
        <header class="flex justify-between items-center mb-12">
            <div>
                <h1 class="text-4xl font-bold gradient-text">Skyline System Console</h1>
                <p class="text-blue-200/40 mt-2">Dynamic Model Monitoring & Execution Engine</p>
            </div>
            <div class="flex gap-4">
                <button id="run-pipeline-btn"
                    class="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-xl font-semibold transition-all shadow-lg shadow-blue-600/20 active:scale-95 flex items-center gap-2">
                    <span>‚ö°</span> Run Full Pipeline
                </button>
            </div>
        </header>

        <!-- System Status Bar -->
        <div id="health-grid" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Health cards injected here -->
        </div>

        <!-- Metrics Dashboard -->
        <div id="metrics-dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
            <!-- Performance metrics cards injected here -->
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- LEFT COLUMN: Control & Data -->
            <div class="lg:col-span-8 space-y-8">
                <!-- Engine Control Center -->
                <div class="glass p-8 rounded-3xl">
                    <h2 class="text-xl font-semibold mb-6 flex items-center gap-3">
                        <span class="text-yellow-400">‚öôÔ∏è</span> Engine Control Center
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button onclick="runStage('preprocess')"
                            class="p-4 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 transition-all text-left">
                            <div class="text-blue-400 font-bold mb-1">1. Preprocess</div>
                            <div class="text-[10px] text-blue-200/40 uppercase">Clean & Encode Raw Data</div>
                        </button>
                        <button onclick="runStage('train')"
                            class="p-4 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 transition-all text-left">
                            <div class="text-green-400 font-bold mb-1">2. Train</div>
                            <div class="text-[10px] text-blue-200/40 uppercase">Train All Engines</div>
                        </button>
                        <button onclick="runStage('predict')"
                            class="p-4 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 transition-all text-left">
                            <div class="text-purple-400 font-bold mb-1">3. Predict</div>
                            <div class="text-[10px] text-blue-200/40 uppercase">Generate Result Sets</div>
                        </button>
                    </div>
                </div>

                <!-- Data Explorer Section -->
                <div class="glass p-8 rounded-3xl">
                    <div class="flex justify-between items-center mb-6">
                        <h2 id="data-title" class="text-xl font-semibold flex items-center gap-3">
                            <span class="text-blue-400">üìä</span> Pipeline Stage: <span id="current-stage-label"
                                class="text-blue-400">Raw</span>
                        </h2>
                        <div class="flex gap-2">
                            <button onclick="setView('raw')" id="btn-raw"
                                class="px-3 py-1 text-[10px] uppercase rounded-lg bg-blue-500/20 text-blue-400 border border-blue-500/30">Raw</button>
                            <button onclick="setView('cleaned')" id="btn-cleaned"
                                class="px-3 py-1 text-[10px] uppercase rounded-lg hover:bg-white/5 text-blue-200/40">Cleaned</button>
                            <button onclick="setView('predictions')" id="btn-predictions"
                                class="px-3 py-1 text-[10px] uppercase rounded-lg hover:bg-white/5 text-blue-200/40">Results</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto rounded-xl border border-white/5">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-white/5 text-blue-200/50">
                                <tr id="data-header">
                                    <!-- Headers injected here -->
                                </tr>
                            </thead>
                            <tbody id="data-body" class="divide-y divide-white/5">
                                <!-- Data rows injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Model Engine Monitor -->
                <div id="console-output"
                    class="hidden glass p-6 rounded-3xl bg-black/40 font-mono text-xs text-blue-200/60 h-48 overflow-y-auto">
                    <p class="text-blue-400 mb-2">> System Ready. Waiting for execution...</p>
                </div>
            </div>

            <!-- RIGHT COLUMN: Interactive Testing -->
            <div class="lg:col-span-4 space-y-8">
                <!-- Prediction System -->
                <div class="glass p-8 rounded-3xl">
                    <h2 class="text-xl font-semibold mb-6 flex items-center gap-3">
                        <span class="text-purple-400">üéØ</span> Interactive Tester
                    </h2>
                    <form id="prediction-form" class="space-y-4">
                        <div>
                            <label class="block text-xs text-blue-200/40 mb-2 uppercase tracking-wider">Select
                                Engine</label>
                            <select name="model" id="model-selector"
                                onchange="if(currentView==='predictions') loadData()"
                                class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 focus:outline-none focus:border-purple-400 transition-all appearance-none">
                                <option value="random_forest">Random Forest (Recommended)</option>
                                <option value="decision_tree">Decision Tree</option>
                                <option value="linear_regression">Linear Regression</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-blue-200/40 mb-2 uppercase">Overall Qual</label>
                                <input type="number" name="OverallQual" value="7"
                                    class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2 focus:outline-none focus:border-blue-400">
                            </div>
                            <div>
                                <label class="block text-xs text-blue-200/40 mb-2 uppercase">Living Area</label>
                                <input type="number" name="GrLivArea" value="1500"
                                    class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2 focus:outline-none focus:border-blue-400">
                            </div>
                            <div>
                                <label class="block text-xs text-blue-200/40 mb-2 uppercase">Garage Cars</label>
                                <input type="number" name="GarageCars" value="2"
                                    class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2 focus:outline-none focus:border-blue-400">
                            </div>
                            <div>
                                <label class="block text-xs text-blue-200/40 mb-2 uppercase">Basement SF</label>
                                <input type="number" name="TotalBsmtSF" value="1000"
                                    class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2 focus:outline-none focus:border-blue-400">
                            </div>
                        </div>
                        <button type="submit"
                            class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-bold transition-all shadow-lg shadow-blue-600/20 active:scale-95">
                            Run Model Prediction
                        </button>
                    </form>

                    <!-- Results -->
                    <div id="result-display" class="mt-8 hidden fade-in text-center p-6 border-t border-white/5">
                        <div class="text-blue-200/40 text-xs mb-1 uppercase tracking-widest">Prediction Result</div>
                        <div id="res-usd" class="text-3xl font-bold mb-1"></div>
                        <div id="res-tnd" class="text-xl text-blue-400 font-semibold opacity-80"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const formatName = (name) => name.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        let currentView = 'raw';

        async function updateHealth() {
            const res = await fetch('/api/health');
            const data = await res.json();
            const grid = document.getElementById('health-grid');
            grid.innerHTML = '';

            Object.entries(data).forEach(([key, status]) => {
                const isOffline = status === 'Offline' || status === 'Missing';
                grid.innerHTML += `
                    <div class="glass p-5 rounded-2xl flex items-center justify-between">
                        <div>
                            <div class="text-xs text-blue-200/40 uppercase mb-1">${formatName(key)}</div>
                            <div class="font-semibold">${status}</div>
                        </div>
                        <div class="w-3 h-3 rounded-full ${isOffline ? 'bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)]' : 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]'}"></div>
                    </div>
                `;
            });
        }

        async function updateMetrics() {
            try {
                const res = await fetch('/api/metrics');
                const data = await res.json();
                const dashboard = document.getElementById('metrics-dashboard');
                if (data.error) {
                    dashboard.innerHTML = `<div class="lg:col-span-3 text-center py-4 text-blue-200/20 uppercase tracking-widest text-xs">${data.error}</div>`;
                    return;
                }
                dashboard.innerHTML = '';

                Object.entries(data).forEach(([key, metrics]) => {
                    dashboard.innerHTML += `
                        <div class="glass p-6 rounded-2xl">
                            <h3 class="text-blue-400 font-semibold mb-4">${formatName(key)}</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between text-sm">
                                    <span class="text-blue-200/40">R¬≤ Score</span>
                                    <span class="font-bold text-lg">${metrics.R2}</span>
                                </div>
                                <div class="w-full bg-white/5 h-1.5 rounded-full">
                                    <div class="bg-blue-500 h-full rounded-full" style="width: ${metrics.R2 * 100}%"></div>
                                </div>
                                <div class="flex justify-between text-[10px] text-blue-200/20 uppercase tracking-wider mt-2">
                                    <span>MAE: ${metrics.MAE.toLocaleString()}</span>
                                    <span>MSE: ${metrics.MSE.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } catch (e) { console.error('Failed to load metrics:', e); }
        }

        async function setView(view) {
            currentView = view;
            const label = document.getElementById('current-stage-label');
            const btns = ['raw', 'cleaned', 'predictions'];

            btns.forEach(b => {
                const el = document.getElementById(`btn-${b}`);
                if (b === view) {
                    el.className = "px-3 py-1 text-[10px] uppercase rounded-lg bg-blue-500/20 text-blue-400 border border-blue-500/30";
                } else {
                    el.className = "px-3 py-1 text-[10px] uppercase rounded-lg hover:bg-white/5 text-blue-200/40";
                }
            });

            label.innerText = formatName(view);
            loadData();
        }

        async function loadData() {
            const header = document.getElementById('data-header');
            const body = document.getElementById('data-body');

            // Clear and show loading state
            body.innerHTML = `<tr><td colspan="5" class="py-12 text-center text-blue-200/20 animate-pulse uppercase tracking-[0.2em] text-[10px]">Synchronizing ${currentView} data...</td></tr>`;

            let endpoint = `/api/data/${currentView}?t=${Date.now()}`;
            if (currentView === 'predictions') {
                const model = document.getElementById('model-selector').value;
                endpoint = `/api/predictions?model=${model}&t=${Date.now()}`;
            }

            try {
                const res = await fetch(endpoint);
                const data = await res.json();
                console.log(`Loaded ${currentView}:`, data.length, "records");

                if (data.error) {
                    body.innerHTML = `<tr><td colspan="5" class="py-12 text-center text-red-400/50 uppercase text-[10px] tracking-widest">${data.error}</td></tr>`;
                    return;
                }

                if (data.length === 0) {
                    body.innerHTML = `<tr><td colspan="5" class="py-12 text-center text-blue-200/20">No data records found.</td></tr>`;
                    return;
                }

                // Dynamically detect all keys from data
                let keys = Object.keys(data[0]);

                header.innerHTML = keys.map(k => `<th class="px-4 py-3 font-medium text-[10px] uppercase tracking-tighter truncate max-w-[120px] text-blue-200/50">${k}</th>`).join('');

                body.innerHTML = data.map(row => `
                <tr class="hover:bg-white/5 transition-colors">
                    ${keys.map(k => {
                    let val = row[k];
                    if (typeof val === 'number') {
                        if (k.includes('Price') || k.includes('USD')) val = '$' + val.toLocaleString();
                        else if (k.includes('TND')) val = val.toLocaleString() + ' TND';
                        else if (val % 1 !== 0) val = val.toFixed(2);
                    }
                    return `<td class="px-4 py-3 truncate max-w-[100px]">${val}</td>`;
                }).join('')}
                </tr>
            `).join('');
            } catch (e) {
                console.error('Data Load Error:', e);
                body.innerHTML = `<tr><td colspan="5" class="py-12 text-center text-red-400/50 uppercase text-[10px] tracking-widest">Failed to load dataset</td></tr>`;
            }
        }

        async function runStage(stage) {
            const consoleBox = document.getElementById('console-output');
            const model = document.getElementById('model-selector').value;

            consoleBox.classList.remove('hidden');
            consoleBox.innerHTML += `<p class="text-blue-400 mt-4">> Running Engine Stage: ${stage} (${stage === 'predict' ? model : 'All'})...</p>`;

            try {
                const res = await fetch(`/api/run/${stage}?model=${model}`, { method: 'POST' });
                const data = await res.json();

                if (data.success) {
                    consoleBox.innerHTML += `<p class="text-green-400">> ${stage} Success!</p><pre class="mt-2 text-white/40 whitespace-pre-wrap">${data.output}</pre>`;
                    updateHealth();
                    updateMetrics();

                    // Auto-switch view based on stage
                    if (stage === 'preprocess') setView('cleaned');
                    else if (stage === 'predict') setView('predictions');
                    else loadData();
                } else {
                    consoleBox.innerHTML += `<p class="text-red-400">> Error: ${data.error}</p>`;
                }
            } catch (e) {
                consoleBox.innerHTML += `<p class="text-red-400">> System Error: ${e.message}</p>`;
            }
            consoleBox.scrollTop = consoleBox.scrollHeight;
        }

        // Run Full Pipeline
        document.getElementById('run-pipeline-btn').addEventListener('click', async () => {
            const btn = document.getElementById('run-pipeline-btn');
            const consoleBox = document.getElementById('console-output');

            btn.disabled = true;
            btn.innerText = '‚ö° Executing...';
            consoleBox.classList.remove('hidden');
            consoleBox.innerHTML = '<p class="text-purple-400">> Initializing full pipeline execution...</p>';

            try {
                const res = await fetch('/api/run_pipeline', { method: 'POST' });
                const data = await res.json();

                if (data.success) {
                    consoleBox.innerHTML += `<p class="text-green-400">> Full Pipeline Success!</p><pre class="mt-2 text-white/40 whitespace-pre-wrap">${data.output}</pre>`;
                    updateHealth();
                    updateMetrics();
                    setView('predictions');
                } else {
                    consoleBox.innerHTML += `<p class="text-red-400">> Execution Error: ${data.error}</p>`;
                }
            } catch (e) {
                consoleBox.innerHTML += `<p class="text-red-400">> System Error: ${e.message}</p>`;
            } finally {
                btn.disabled = false;
                btn.innerText = '‚ö° Run Full Pipeline';
            }
            consoleBox.scrollTop = consoleBox.scrollHeight;
        });

        // Prediction Form
        document.getElementById('prediction-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const resBox = document.getElementById('result-display');

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            btn.disabled = true;
            btn.innerText = 'Calculating...';

            try {
                const res = await fetch('/api/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();

                if (result.success) {
                    resBox.classList.remove('hidden');
                    document.getElementById('res-usd').innerText = `$${result.prediction_usd.toLocaleString()} `;
                    document.getElementById('res-tnd').innerText = `${result.prediction_tnd.toLocaleString()} TND`;
                } else {
                    alert('Error: ' + result.error);
                }
            } finally {
                btn.disabled = false;
                btn.innerText = 'Run Model Prediction';
            }
        });

        async function updateFormDefaults() {
            try {
                const res = await fetch('/api/stats');
                const stats = await res.json();
                if (stats.error) return;

                const form = document.getElementById('prediction-form');
                Object.entries(stats).forEach(([name, value]) => {
                    const input = form.querySelector(`[name = "${name}"]`);
                    if (input) {
                        input.value = value;
                        // Add subtle highlight to show it's dynamic
                        input.classList.add('border-blue-400/50');
                        setTimeout(() => input.classList.remove('border-blue-400/50'), 2000);
                    }
                });
            } catch (e) { console.error('Failed to load form defaults:', e); }
        }

        // Initial Load
        updateHealth();
        updateMetrics();
        loadData();
        updateFormDefaults();
        setInterval(updateHealth, 10000);
    </script>
</body>

</html>